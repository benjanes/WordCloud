var WordCloud=new Marionette.Application;WordCloud.on("before:start",function(){var a=Marionette.LayoutView.extend({el:"#app-container",regions:{filelist:"#filelist-region",canvas:"#canvas-region",selectedFile:"#selectedfile-region",settings:"#settings-region",load:"#load-region"}});WordCloud.regions=new a}),WordCloud.on("file:select",function(a){WordCloud.regions.canvas.show(new WordCloud.Canvas.Instructions2({model:a})),WordCloud.Selectedfile.Controller.showFile(a),WordCloud.Settings.Controller.showSettings(a)}),WordCloud.on("cloud:draw",function(a){var b=$.Deferred();b.done(function(b){WordCloud.Canvas.Controller.drawCloud(a,b)}),b.resolve(WordCloud.Settings.Controller.getSettings())}),WordCloud.on("start",function(){Backbone.history&&Backbone.history.start()}),WordCloud.module("Wordlist",function(a,b,c,d,e,f){a.File=c.Model.extend({defaults:{fileName:"",fileWords:""},initialize:function(){this.isNew()&&this.set("created",Date.now())}}),a.FileCollection=c.Collection.extend({model:a.File,localStorage:new c.LocalStorage("wordcloud-files"),comparator:function(a){return-a.get("created")}});var g={getFiles:function(){var b=new a.FileCollection;if(b.fetch(),0===b.length){var c=new a.File({fileName:"Example",fileWords:["this","this","is","is","is","wordcloud","wordcloud","wordcloud","wordcloud"]});b.add(c),c.save()}return b}};b.reqres.setHandler("wordlist:files",function(){return g.getFiles()})}),WordCloud.module("FileCollection",function(a,b,c,d,e,f){a.Router=d.AppRouter.extend({appRoutes:{}}),a.Controller=function(){this.fileCollection=new b.Wordlist.FileCollection},f.extend(a.Controller.prototype,{start:function(){this.showInstructions(),this.showLoadButton(),this.showFileList()},showInstructions:function(){b.regions.canvas.show(new b.Canvas.Instructions1)},showLoadButton:function(){b.regions.load.show(new b.Load.View)},showFileList:function(){var a=b.request("wordlist:files");e.when(a).done(function(a){var c=new b.Filelist.Files({collection:a});c.on("childview:file:delete",function(a,b){b.destroy()}),c.on("childview:file:select",function(a,c){b.trigger("file:select",c)}),b.regions.filelist.show(c)})}}),a.addInitializer(function(){a.controller=new a.Controller,a.router=new a.Router({controller:a.controller}),a.controller.start()})}),WordCloud.module("Filelist",function(a,b,c,d,e,f){a.File=d.ItemView.extend({template:"fileitem",tagName:"li",events:{"click button.js-delete":"deleteFile","click button.js-select":"selectFile"},onRender:function(){this.$el.find("button").tooltip()},deleteFile:function(a){a.stopPropagation(),this.trigger("file:delete",this.model)},selectFile:function(a){a.stopPropagation(),this.$el.hasClass("selected")?a.preventDefault():(e(".selected").removeClass("selected"),e("button.js-select").tooltip(),this.$el.addClass("selected"),this.$el.find("button.js-select").tooltip("destroy"),this.trigger("file:select",this.model))},noAction:function(a){a.stopPropagation(),a.preventDefault()},remove:function(){var a=this;this.$el.fadeOut(function(){d.ItemView.prototype.remove.call(a)})}}),a.Files=d.CompositeView.extend({template:"fileitems",className:"list-container control-panel-section",tagName:"section",childView:a.File,childViewContainer:"ol",initialize:function(){this.listenTo(b,"file:load",this.addFile)},addFile:function(a){return this.collection.add(a),a.save(),this}})}),WordCloud.module("Canvas",function(a,b,c,d,e,f){a.Instructions1=d.ItemView.extend({template:"instructions_1"}),a.Instructions2=d.ItemView.extend({template:"instructions_2",events:{"click button.js-draw-cloud":"drawCloud"},drawCloud:function(){b.trigger("cloud:draw",this.model)}}),a.Wordcloud=d.ItemView.extend({template:"canvas",className:"canvas-container",events:{"click a#download-image":"downloadImage","click button.js-draw-cloud":"drawNewCloud"},downloadImage:function(){var a=document.getElementById("word-cloud"),b=a.toDataURL("image/png");this.$el.find("a#download-image").attr("href",b)},drawNewCloud:function(){b.trigger("cloud:draw",this.model)}})}),WordCloud.module("Canvas",function(a,b,c,d,e,f){a.Controller={drawCloud:function(c,d){function e(a,b){for(var c=0;c<b.length;c++)if(b[c].word===a)return!0;return!1}function f(a){var b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return b?{r:parseInt(b[1],16),g:parseInt(b[2],16),b:parseInt(b[3],16)}:null}var g=new a.Wordcloud({model:c});b.regions.canvas.show(g);var h,i=d.textSize,j=d.wordLimit,k=d.omittedWords.split(" "),l=d.fontType,m=d.cloudSpread;if(-1!==d.fontColor.indexOf("#")){var n=f(d.fontColor);h="rgb("+n.r+","+n.g+","+n.b+")"}else h=d.fontColor;var o,p=d.allowOverlap,q=d.randomColors;o="string"==typeof c.attributes.fileWords?c.attributes.fileWords.split(","):c.attributes.fileWords;var r=document.getElementById("word-cloud"),s=r.getContext("2d"),t={minX:0,minY:0,width:0,height:0},u=function(a,b,c,d,f,g,h){function i(a){this.word=a,this.count=1,this.font=0,this.fontHeight=0}var j=[],k=[],l=b?b:30,m=f?f:"Arial",n=function(a,b){return Math.floor(a*b)},o=function(a,b,c){if(e(a,j)){var f=k.indexOf(a);j[f].count+=1}else{if(-1!==d.indexOf(a))return!1;var g=new i(a);j.push(g),k.push(a)}},p=function(a,b,c){var d=a.count;a.count=d/t,a.fontHeight=n(a.count,l),a.font=a.fontHeight+"px "+m},q=function(a,b,c){s.font=a.font,a.fillWidth=s.measureText(a.word).width},r=function(a,b,c){function d(){return Math.floor(256*Math.random())}h?a.color="rgb("+d()+","+d()+","+d()+")":a.color=g};a.map(o),j.sort(function(a,b){return b.count-a.count});var t=j[0].count;return j=c?j.slice(0,c):j,j.map(p),j.map(q),j.map(r),j},v=function(a,b){function c(a,b,c,d,e){this.word=e,this.minX=a,this.maxX=b,this.minY=c,this.maxY=d}var d=[],e=b,f=0,g=function(a,b,g){var h,i,j;h=90*(1-Math.floor(3*Math.random())),j=e,i=j;var k=function(){var a=Math.floor((.5-Math.random())*i),b=Math.floor((.5-Math.random())*i);return l(a,b)},l=function(b,c){var d={};return d.x=b,d.y=c,-90===h?(d.minX=b-a.fontHeight,d.maxX=b,d.minY=c-a.fillWidth,d.maxY=c):90===h?(d.minX=b,d.maxX=b+a.fontHeight,d.minY=c,d.maxY=c+a.fillWidth):(d.minX=b,d.maxX=b+a.fillWidth,d.minY=c-a.fontHeight,d.maxY=c),d.mid1={x:d.minX,y:(d.maxY-d.minY)/2},d.mid2={x:(d.maxX-d.minX)/2,y:d.minY},d.mid3={x:d.maxX,y:(d.maxY-d.minY)/2},d.mid4={x:(d.maxX-d.minX)/2,y:d.maxY},d},m=function(b,e){-90===h?d.push(new c(b-a.fontHeight,b,e-a.fillWidth,e,a.word)):90===h?d.push(new c(b,b+a.fontHeight,e,e+a.fillWidth,a.word)):d.push(new c(b,b+a.fillWidth,e-a.fontHeight,e,a.word))},n=function(){var b=k();if(p)a.xCoord=b.x,a.yCoord=b.y,a.rot=h,m(b.x,b.y);else if(d.length>0)for(var c=0;c<d.length;c++){if(!((b.minX>d[c].maxX||b.minX<d[c].minX||b.maxY>d[c].maxY||b.maxY<d[c].minY)&&(b.minX>d[c].maxX||b.minX<d[c].minX||b.minY>d[c].maxY||b.minY<d[c].minY)&&(b.maxX>d[c].maxX||b.maxX<d[c].minX||b.maxY>d[c].maxY||b.maxY<d[c].minY)&&(b.maxX>d[c].maxX||b.maxX<d[c].minX||b.minY>d[c].maxY||b.minY<d[c].minY)&&(b.mid1.x>d[c].maxX||b.mid1.x<d[c].minX||b.mid1.y>d[c].maxY||b.mid1.y<d[c].minY)&&(b.mid2.x>d[c].maxX||b.mid2.x<d[c].minX||b.mid2.y>d[c].maxY||b.mid2.y<d[c].minY)&&(b.mid3.x>d[c].maxX||b.mid3.x<d[c].minX||b.mid3.y>d[c].maxY||b.mid3.y<d[c].minY)&&(b.mid4.x>d[c].maxX||b.mid4.x<d[c].minX||b.mid4.y>d[c].maxY||b.mid4.y<d[c].minY)))return f++,f>=1e4&&(i+=10),n();if(c===d.length-1){a.xCoord=b.x,a.yCoord=b.y,a.rot=h,m(b.x,b.y),i=j;break}}else a.xCoord=b.x,a.yCoord=b.y,a.rot=h,m(b.x,b.y)};n()};a.forEach(g),d.sort(function(a,b){return a.minX-b.minX});var h=Math.floor(d[0].minX);d.sort(function(a,b){return a.minY-b.minY});var i=Math.floor(d[0].minY);d.sort(function(a,b){return b.maxX-a.maxX});var j=Math.ceil(d[0].maxX)-h;d.sort(function(a,b){return b.maxY-a.maxY});var k=Math.ceil(d[0].maxY)-i;return t={minX:h,minY:i,width:j,height:k},a},w=function(a,b){var c=function(a){s.translate(a.xCoord,a.yCoord),s.rotate(a.rot*Math.PI/180),s.font=a.font,s.fillStyle=a.color,s.fillText(a.word,0,0),s.rotate(-a.rot*Math.PI/180),s.translate(-a.xCoord,-a.yCoord)},d=Math.abs(b.minX)+5,e=Math.abs(b.minY)+5;r.height=b.height+10,r.width=b.width+10,s.translate(d,e),s.save(),a.forEach(c)},x=u(o,i,j,k,l,h,q),y=v(x,m);w(y,t)}}}),WordCloud.module("Selectedfile",function(a,b,c,d,e,f){a.File=d.ItemView.extend({template:"selectedfile"})}),WordCloud.module("Selectedfile",function(a,b,c,d,e,f){a.Controller={showFile:function(c){var d=new a.File({model:c});b.regions.selectedFile.show(d)}}}),WordCloud.module("Settings",function(a,b,c,d,e,f){a.View=d.ItemView.extend({template:"settings",className:"settings-container",onRender:function(){this.$el.css("display","none").fadeIn(),this.$el.find(".js-tooltip").tooltip(),this.$el.find(".color-select-area").colorpicker()}})}),WordCloud.module("Settings",function(a,b,c,d,e,f){a.Controller={showSettings:function(c){var d=new a.View({model:c});b.regions.settings.show(d)},getSettings:function(){var a=c.Syphon.serialize(e("form"));return a}}}),WordCloud.module("Load",function(a,b,c,d,e,f){a.View=d.ItemView.extend({template:"load",childView:b.Filelist.File,events:{"change input":"clickedInput"},clickedInput:function(a){var c=a.target.files[0];if(c)if(c.type.match("text.*")){var d=new FileReader;d.readAsText(c),d.onload=function(a){var d=c.name,e=a.target.result,f=e.split(" ").filter(function(a){return"{"!==a.charAt(0)&&-1===a.indexOf("\\")}),g=f.map(function(a){return a.replace(/\W/g,"").toLowerCase()}),h=new b.Wordlist.File({fileName:d,fileWords:g});b.trigger("file:load",h)}}else alert(c.name+" is not a text file. Please choose a text file to load!");else alert("File loading failed. Please give it another shot.")}})});